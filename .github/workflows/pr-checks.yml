name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # PR Size Check
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;
            
            if (total > 1000) {
              core.setFailed(`PR is too large (${total} lines). Consider splitting into smaller PRs.`);
            } else if (total > 500) {
              core.warning(`PR is quite large (${total} lines). Consider reviewing if it can be split.`);
            } else {
              core.info(`PR size is acceptable (${total} lines).`);
            }

  # Auto-label based on files changed
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Label PR
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  # Check for breaking changes
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for breaking changes in commit messages
        run: |
          if git log --format=%B origin/main..HEAD | grep -i "BREAKING CHANGE"; then
            echo "⚠️ Breaking changes detected in commits"
            echo "breaking_change=true" >> $GITHUB_ENV
          else
            echo "✅ No breaking changes detected"
            echo "breaking_change=false" >> $GITHUB_ENV
          fi
      
      - name: Comment on PR if breaking changes
        if: env.breaking_change == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Breaking Changes Detected**\n\nThis PR contains breaking changes. Please ensure:\n- [ ] Documentation is updated\n- [ ] Migration guide is provided\n- [ ] Version is bumped appropriately'
            })

  # Test coverage check
  coverage-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run tests with coverage
        run: pnpm test -- --coverage --coverageReporters=json-summary
      
      - name: Check coverage threshold
        run: |
          COVERAGE=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "❌ Coverage is below 50%"
            exit 1
          else
            echo "✅ Coverage is acceptable"
          fi
